name: NPM Audit Fix

on:
  schedule:
    # Run every Monday at 10:00 AM UTC (after model updates at 9:00)
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  audit-fix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit fix
        id: audit-fix
        continue-on-error: true
        run: npm audit fix

      - name: Check for changes and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet; then
            echo "No audit fixes needed"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and switch to new branch
          BRANCH_NAME="automated/npm-audit-fix"
          git checkout -b ${BRANCH_NAME}

          # Commit changes
          git add package.json package-lock.json
          git commit -m "Fix npm audit vulnerabilities"

          # Push branch
          git push origin ${BRANCH_NAME} --force

          # Create PR (will fail gracefully if PR already exists)
          gh pr create \
            --title "Fix npm audit vulnerabilities" \
            --body "This PR automatically fixes npm audit vulnerabilities by running \`npm audit fix\`.

          ## Changes
          - Updated \`package.json\` and \`package-lock.json\` with security fixes

          This PR was automatically generated by the \`npm-audit-fix\` workflow." \
            --base main \
            --head ${BRANCH_NAME} \
            --label dependencies \
            --repo ${GITHUB_REPOSITORY} || echo "PR already exists or could not be created"
