name: Update OpenAI Models

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-models:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: '24.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run model update script
        id: update
        continue-on-error: true
        run: node scripts/update-openai-models.js

      - name: Check for changes and create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet; then
            echo "Model identifiers are already up to date"
            exit 0
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create and switch to new branch
          BRANCH_NAME="automated/update-openai-models"
          git checkout -b ${BRANCH_NAME}

          # Commit changes
          git add action.cjs src/openaiExplainPatch.js
          git commit -m "Update OpenAI model identifiers"

          # Push branch
          git push origin ${BRANCH_NAME} --force

          # Create PR (will fail gracefully if PR already exists)
          gh pr create \
            --title "Update OpenAI model identifiers" \
            --body "This PR automatically updates the OpenAI model identifiers to the latest versions based on the [official documentation](https://platform.openai.com/docs/models).

          ## Changes
          - Updated \`action.cjs\` with latest OpenAI model identifiers
          - Updated \`src/openaiExplainPatch.js\` with latest GPT models including GPT-5.3-Codex

          ## About GPT-5.3-Codex
          GPT-5.3-Codex is the first model classified as High capability for cybersecurity-related tasks under OpenAI's Preparedness Framework, and the first directly trained to identify software vulnerabilities. This update includes comprehensive cybersecurity safety measures including safety training, automated monitoring, trusted access for advanced capabilities, and enforcement pipelines.

          This PR was automatically generated by the \`update-openai-models\` workflow." \
            --base main \
            --head ${BRANCH_NAME} \
            --label dependencies \
            --repo ${GITHUB_REPOSITORY} || echo "PR already exists or could not be created"
